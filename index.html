<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Investment Map Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; background: linear-gradient(135deg, #0a0a0f 0%, #12121a 100%); }
        #map { width: 100vw; height: 100vh; }

        .control-panel {
            position: absolute; top: 24px; left: 24px;
            background: linear-gradient(165deg, rgba(25, 25, 35, 0.95) 0%, rgba(18, 18, 25, 0.98) 100%);
            backdrop-filter: blur(50px) saturate(180%);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 20px;
            padding: 16px;
            min-width: 140px;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7),
                        0 0 40px rgba(212, 175, 55, 0.03),
                        inset 0 1px 0 rgba(255,255,255,0.1),
                        inset 0 -1px 0 rgba(0,0,0,0.3);
        }
        .control-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 20px; right: 20px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.6), rgba(245, 158, 11, 0.4), transparent);
            border-radius: 2px;
        }
        .control-panel::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 28px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 50%);
            pointer-events: none;
        }
        .control-panel::-webkit-scrollbar { width: 5px; }
        .control-panel::-webkit-scrollbar-track { background: transparent; }
        .control-panel::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.5), rgba(99, 102, 241, 0.3)); 
            border-radius: 10px; 
        }
        .control-panel::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.7), rgba(99, 102, 241, 0.5)); 
        }

        .panel-header {
            font-size: 13px; font-weight: 700; margin-bottom: 14px;
            color: #fff;
            display: flex; align-items: center; gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            letter-spacing: -0.3px;
            position: relative;
            z-index: 1;
        }
        .panel-header::before {
            content: 'â—†';
            font-size: 14px;
            background: linear-gradient(135deg, #d4af37, #f5c542);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 8px rgba(212, 175, 55, 0.5));
        }
        .panel-header::after {
            display: none;
        }

        .layer-group { margin-bottom: 12px; }
        .layer-title {
            font-size: 9px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px; 
            color: rgba(255,255,255,0.4);
            display: flex; align-items: center; gap: 6px;
        }
        .layer-title::after {
            content: ''; flex: 1; height: 1px;
            background: linear-gradient(90deg, rgba(255,255,255,0.1), transparent);
        }

        .layer-item {
            display: flex; align-items: center;
            padding: 8px 10px; margin-bottom: 6px;
            background: rgba(255,255,255,0.02);
            border: 1px solid transparent;
            border-radius: 10px; cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .layer-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.05));
            opacity: 0;
            transition: opacity 0.25s;
        }
        .layer-item:hover { 
            background: rgba(255,255,255,0.05); 
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .layer-item:hover::before { opacity: 1; }
        .layer-item:active { transform: scale(0.98); }

        .layer-item input[type="checkbox"] { position: absolute; opacity: 0; }
        .toggle {
            width: 28px; height: 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px; position: relative;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 8px;
            flex-shrink: 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .toggle::after {
            content: ''; position: absolute;
            width: 12px; height: 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 50%; top: 2px; left: 2px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .layer-item input:checked + .toggle {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 12px rgba(139, 92, 246, 0.4);
        }
        .layer-item input:checked + .toggle::after {
            left: 14px; background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .layer-color {
            width: 8px; height: 8px; border-radius: 50%;
            margin-right: 6px; 
            box-shadow: 0 0 8px currentColor, 0 0 16px currentColor;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        .layer-item input:checked ~ .layer-color {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 8px currentColor, 0 0 16px currentColor; }
            50% { box-shadow: 0 0 12px currentColor, 0 0 24px currentColor; }
        }
        .layer-name { flex: 1; font-size: 10px; color: rgba(255,255,255,0.8); }
        .layer-count {
            font-size: 8px; font-weight: 600; color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.08);
            padding: 2px 5px; border-radius: 4px;
            font-variant-numeric: tabular-nums;
        }
        .layer-item input:checked ~ .layer-count {
            background: rgba(139, 92, 246, 0.2);
            color: rgba(255,255,255,0.8);
        }

        
        /* ê²€ìƒ‰ íŒ¨ë„ */
        .search-panel {
            position: absolute; top: 20px; left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(160deg, rgba(22, 22, 30, 0.97), rgba(15, 15, 20, 0.99));
            backdrop-filter: blur(40px) saturate(200%);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 18px;
            padding: 14px 18px;
            z-index: 150;
            display: flex; gap: 12px; align-items: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .search-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 20%; right: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), transparent);
        }
        .search-input {
            width: 300px; padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            color: #fff; font-size: 13px;
            font-family: 'Pretendard', sans-serif;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-input::placeholder { color: rgba(255,255,255,0.35); }
        .search-input:focus {
            border-color: rgba(139, 92, 246, 0.5);
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }
        .search-btn {
            padding: 12px 22px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            border: none; border-radius: 12px;
            color: #fff; font-size: 13px; font-weight: 600;
            cursor: pointer;
            font-family: 'Pretendard', sans-serif;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }
        .search-btn:hover { transform: scale(1.02); }
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: rgba(12, 12, 16, 0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-top: 8px;
            max-height: 300px; overflow-y: auto;
            display: none;
        }
        .search-results.active { display: block; }
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.15s;
        }
        .search-result-item:hover { background: rgba(99,102,241,0.2); }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-name { font-size: 13px; color: #fff; margin-bottom: 4px; }
        .search-result-addr { font-size: 11px; color: rgba(255,255,255,0.5); }
        .search-result-cat {
            display: inline-block;
            font-size: 10px; padding: 2px 6px;
            background: rgba(99,102,241,0.3);
            border-radius: 4px; color: #a5b4fc;
            margin-right: 6px;
        }

        /* ê°€ê²© í•„í„° */
        .price-filter {
            margin-top: 8px; padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .price-filter-title {
            font-size: 10px; font-weight: 500;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }
        .price-option {
            display: flex; align-items: center;
            padding: 6px 8px; margin-bottom: 4px;
            cursor: pointer; border-radius: 6px;
            transition: all 0.15s;
        }
        .price-option:hover { background: rgba(255,255,255,0.05); }
        .price-option input { margin-right: 8px; accent-color: #6366f1; }
        .price-option label {
            font-size: 11px; color: rgba(255,255,255,0.7);
            cursor: pointer;
        }

        /* ê´€ì‹¬ ëª©ë¡ íŒ¨ë„ */
        .favorites-panel {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(12, 12, 16, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 14px;
            min-width: 280px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .favorites-panel.active { display: block; }
        .favorites-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 12px;
        }
        .favorites-title {
            font-size: 13px; font-weight: 600;
            color: rgba(255,255,255,0.9);
        }
        .favorites-close {
            background: none; border: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer; font-size: 16px;
        }
        .favorites-empty {
            font-size: 12px; color: rgba(255,255,255,0.4);
            text-align: center; padding: 20px;
        }
        .favorite-item {
            display: flex; justify-content: space-between;
            align-items: center;
            padding: 10px 12px; margin-bottom: 6px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .favorite-item:hover { background: rgba(99,102,241,0.15); }
        .favorite-info { flex: 1; }
        .favorite-name { font-size: 12px; color: #fff; margin-bottom: 2px; }
        .favorite-addr { font-size: 10px; color: rgba(255,255,255,0.4); }
        .favorite-remove {
            background: none; border: none;
            color: rgba(255,255,255,0.3);
            cursor: pointer; font-size: 14px;
            padding: 4px;
        }
        .favorite-remove:hover { color: #ef4444; }

        /* ê´€ì‹¬ ëª©ë¡ í† ê¸€ ë²„íŠ¼ */
        .favorites-toggle {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(12, 12, 16, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px 18px;
            color: #fff; font-size: 12px;
            cursor: pointer; z-index: 99;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .favorites-toggle:hover { background: rgba(99,102,241,0.3); }
        .favorites-count {
            background: #ef4444;
            padding: 2px 6px; border-radius: 10px;
            font-size: 10px; font-weight: 600;
        }

         else {
        // í•„í„° í•´ì œ - ì›ë˜ ìƒíƒœë¡œ
        var categories = ['exact_match', 'need_check', 'nearby_500m', 'nearby_1km', 'general_auction', 'general_public'];
        categories.forEach(function(cat) {
            var layerChk = document.getElementById('layer-' + cat);
            if (layerChk) {
                markers[cat].forEach(function(m) {
                    m.setMap(layerChk.checked ? map : null);
                });
            }
        });
        document.getElementById('count-500m').textContent = '0';
    }
}

function init() {
    var container = document.getElementById('map');
    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(36.5, 127.5),
        level: 13
    });

    // ì² ë„
    DATA_rail.forEach(function(d) {
        var m = createMarker(d.lat, d.lng, COLORS.railway, 'rail');
        var info = '<div style="padding:14px 18px;background:#1a1a1f;color:#fff;border-radius:10px;border:1px solid rgba(255,255,255,0.1);font-family:Pretendard,sans-serif"><div style="font-weight:600;font-size:14px;margin-bottom:4px">' + (d.station || d.name) + '</div><div style="color:rgba(255,255,255,0.5);font-size:12px">' + (d.address || d.line || 'ì² ë„ì˜ˆì •ì§€') + '</div><button onclick="addToFavorites(\'' + (d.station || d.name).replace(/'/g, "\\'") + '\',\'' + (d.address || '').replace(/'/g, "\\'") + '\',' + d.lat + ',' + d.lng + ',\'ì² ë„\')" style="margin-top:8px;padding:6px 12px;background:#6366f1;border:none;border-radius:6px;color:#fff;font-size:11px;cursor:pointer">â­ ê´€ì‹¬ì¶”ê°€</button></div>';
        addClickEvent(m, info);
        markers.railway.push(m);
    });

    // ê³ ì†ë„ë¡œIC
    DATA_highway.forEach(function(d) {
        var m = createMarker(d.lat, d.lng, COLORS.highway, 'highway');
        var info = '<div style="padding:14px 18px;background:#1a1a1f;color:#fff;border-radius:10px;border:1px solid rgba(255,255,255,0.1);font-family:Pretendard,sans-serif"><div style="font-weight:600;font-size:14px">' + d.name + '</div><div style="color:rgba(255,255,255,0.5);font-size:12px;margin-top:4px">' + (d.address || 'ê³ ì†ë„ë¡œì°©ê³µ') + '</div></div>';
        addClickEvent(m, info);
        markers.highway.push(m);
    });

    // ICì§„ì¶œì…ë¡œ
    DATA_ic.forEach(function(d) {
        var m = createMarker(d.lat, d.lng, '#ec4899', 'ic');
        var info = '<div style="padding:14px 18px;background:#1a1a1f;color:#fff;border-radius:10px;border:1px solid rgba(255,255,255,0.1);font-family:Pretendard,sans-serif"><div style="font-weight:600;font-size:14px">' + d.name + '</div><div style="color:rgba(255,255,255,0.5);font-size:12px;margin-top:4px">' + (d.address || 'ICì§„ì¶œì…ë¡œ') + '</div></div>';
        addClickEvent(m, info);
        markers.ic.push(m);
    });

    // ê°œë°œì˜ˆì •ì§€
    DATA_dev.forEach(function(d) {
        var lat, lng;
        if (d.lat && d.lng) {
            lat = d.lat;
            lng = d.lng;
        } else if (d.path && d.path.length > 0) {
            lat = d.path.reduce(function(s, p) { return s + p[0]; }, 0) / d.path.length;
            lng = d.path.reduce(function(s, p) { return s + p[1]; }, 0) / d.path.length;
        } else {
            return;
        }
        var m = createMarker(lat, lng, COLORS.development, 'dev');
        var info = '<div style="padding:14px 18px;background:#1a1a1f;color:#fff;border-radius:10px;border:1px solid rgba(255,255,255,0.1);font-family:Pretendard,sans-serif;max-width:280px"><div style="font-weight:600;font-size:13px">' + d.name + '</div><div style="color:rgba(255,255,255,0.5);font-size:11px;margin-top:6px">' + (d.address || 'ê°œë°œì˜ˆì •ì§€') + '</div></div>';
        addClickEvent(m, info);
        markers.development.push(m);
    });

    // ì§€êµ¬ë‚´ (ì •í™• ë§¤ì¹­) - ë¹¨ê°„ìƒ‰ ê°•ì¡°
    DATA_inside.forEach(function(d) {
        var m = createMarker(d.lat, d.lng, COLORS.inside, 'inside');
        var info = createAuctionInfo(d, 'ì§€êµ¬ë‚´');
        addClickEvent(m, info, d);
        markers.inside.push(m); auctionDataByMarker.set(m, d);
        m.setMap(map);
    });

    // ì§€êµ¬ì¸ê·¼
    DATA_nearby.forEach(function(d) {
        var m = createMarker(d.lat, d.lng, COLORS.nearby, 'auction');
        var info = createAuctionInfo(d, 'ì§€êµ¬ì¸ê·¼');
        addClickEvent(m, info, d);
        markers.nearby.push(m); auctionDataByMarker.set(m, d);
        m.setMap(map);
    });

    // ê²½ë§¤
    DATA_auction.forEach(function(d) {
        var m = createMarkerNoMap(d.lat, d.lng, COLORS.auction, 'auction');
        var info = createAuctionInfo(d, 'ê²½ë§¤');
        addClickEvent(m, info, d);
        markers.general_auction.push(m); auctionDataByMarker.set(m, d);
    });

    // ê³µë§¤
    DATA_public.forEach(function(d) {
        var m = createMarkerNoMap(d.lat, d.lng, COLORS.public, 'public');
        var info = createAuctionInfo(d, 'ê³µë§¤');
        addClickEvent(m, info, d);
        markers.general_public.push(m); auctionDataByMarker.set(m, d);
    });

    // í† ì§€ë³´ìƒêµ¬ì—­ í´ë¦¬ê³¤ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
    fetch("data_proj.json")
        .then(function(r) { return r.json(); })
        .then(function(projData) {
            console.log("í´ë¦¬ê³¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", projData.length);
            DATA_proj = projData;
            
            // í† ì§€ë³´ìƒêµ¬ì—­ í´ë¦¬ê³¤ - ê³µìœ  InfoWindow
            var polygonInfowindow = new kakao.maps.InfoWindow({
                removable: true
            });

            DATA_proj.forEach(function(d) {
                if (!d.path || d.path.length < 3) return;
                var path = d.path.map(function(c) { return new kakao.maps.LatLng(c[0], c[1]); });
                var poly = new kakao.maps.Polygon({
                    path: path,
                    strokeWeight: 2,
                    strokeColor: '#f97316',
                    strokeOpacity: 0.9,
                    fillColor: '#f97316',
                    fillOpacity: 0.12
                });

                // í´ë¦¬ê³¤ì„ ì§€ë„ì— ì¶”ê°€
                poly.setMap(map);

                // íŒì—… ë°ì´í„°
                var name = d.name || 'ì‚¬ì—…ì§€êµ¬';
                var parcels = d.parcels || 0;
                var boundaryPoints = d.boundaryPoints || d.path.length;

                // í´ë¦­ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(poly, 'click', function(mouseEvent) {
                    // íŒì—… HTML
                    var contentHtml = '<div style="padding:16px 20px;font-size:13px;max-width:320px;background:#1a1a1f;color:#fff;border-radius:10px;border:1px solid rgba(255,255,255,0.15);box-shadow:0 4px 12px rgba(0,0,0,0.5)">' +
                        '<div style="font-weight:600;font-size:14px;margin-bottom:12px;color:#f97316;line-height:1.4">' + name + '</div>' +
                        '<div style="display:flex;flex-direction:column;gap:8px">' +
                        '<div style="display:flex;align-items:center;gap:8px;color:#cbd5e1">' +
                        '<span style="width:20px;text-align:center">ğŸ“</span>' +
                        '<span style="font-size:12px">í† ì§€ í•„ì§€: <strong style="color:#fff">' + parcels.toLocaleString() + 'ê°œ</strong></span>' +
                        '</div>' +
                        '<div style="display:flex;align-items:center;gap:8px;color:#cbd5e1">' +
                        '<span style="width:20px;text-align:center">ğŸ”·</span>' +
                        '<span style="font-size:12px">ê²½ê³„ ì : <strong style="color:#fff">' + boundaryPoints.toLocaleString() + 'ê°œ</strong></span>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                    polygonInfowindow.setContent(contentHtml);
                    polygonInfowindow.setPosition(mouseEvent.latLng);
                    polygonInfowindow.open(map);
                });

                markers.land.push(poly);
            });
            
            console.log("í´ë¦¬ê³¤ ë Œë”ë§ ì™„ë£Œ:", DATA_proj.length);
        })
        .catch(function(err) {
            console.error("í´ë¦¬ê³¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
        });

    kakao.maps.event.addListener(map, 'click', function() {
        if (curPoly) { curPoly.setMap(null); curPoly = null; }
    });

    console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ!');
    console.log('ì§€êµ¬ë‚´:', markers.inside.length);
    console.log('ì§€êµ¬ì¸ê·¼:', markers.nearby.length);

    // í´ëŸ¬ìŠ¤í„°ëŸ¬ ì´ˆê¸°í™”
    var clusterStyles = [
        { width: 40, height: 40, background: 'rgba(99,102,241,0.9)', borderRadius: '20px', color: '#fff', textAlign: 'center', lineHeight: '40px', fontSize: '13px', fontWeight: '600' },
        { width: 50, height: 50, background: 'rgba(139,92,246,0.95)', borderRadius: '25px', color: '#fff', textAlign: 'center', lineHeight: '50px', fontSize: '14px', fontWeight: '600' },
        { width: 60, height: 60, background: 'rgba(168,85,247,1)', borderRadius: '30px', color: '#fff', textAlign: 'center', lineHeight: '60px', fontSize: '16px', fontWeight: '700' }
    ];

    // ê²½ë§¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ (ì„±ëŠ¥ ìµœì í™”: ë” ê³µê²©ì ì¸ í´ëŸ¬ìŠ¤í„°ë§)
    clusterers.general_auction = new kakao.maps.MarkerClusterer({
        map: null,
        averageCenter: true,
        minLevel: 3,  // ì¤Œ ë ˆë²¨ 3 ì´ìƒì—ì„œ í´ëŸ¬ìŠ¤í„°ë§ (ë” ê³µê²©ì )
        disableClickZoom: false,
        calculator: [10, 50, 100],  // ë” ì‘ì€ ê·¸ë£¹ë„ í´ëŸ¬ìŠ¤í„°ë§
        styles: clusterStyles
    });
    clusterers.general_auction.addMarkers(markers.general_auction);

    // ê³µë§¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ (ì„±ëŠ¥ ìµœì í™”: ë” ê³µê²©ì ì¸ í´ëŸ¬ìŠ¤í„°ë§)
    clusterers.general_public = new kakao.maps.MarkerClusterer({
        map: null,
        averageCenter: true,
        minLevel: 3,  // ì¤Œ ë ˆë²¨ 3 ì´ìƒì—ì„œ í´ëŸ¬ìŠ¤í„°ë§ (ë” ê³µê²©ì )
        disableClickZoom: false,
        calculator: [10, 50, 100],  // ë” ì‘ì€ ê·¸ë£¹ë„ í´ëŸ¬ìŠ¤í„°ë§
        styles: clusterStyles
    });
    clusterers.general_public.addMarkers(markers.general_public);

    console.log('í´ëŸ¬ìŠ¤í„°ë§ ì´ˆê¸°í™”:', markers.general_auction.length, 'ê²½ë§¤,', markers.general_public.length, 'ê³µë§¤');
}


// ë§µì— ì¶”ê°€í•˜ì§€ ì•ŠëŠ” ë§ˆì»¤ ìƒì„± (í´ëŸ¬ìŠ¤í„°ëŸ¬ìš©)
function createMarkerNoMap(lat, lng, color, type) {
    var size = type === 'auction' || type === 'public' ? 8 : 10;
    var img = new kakao.maps.MarkerImage(
        'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="' + (size*2) + '" height="' + (size*2) + '"><circle cx="' + size + '" cy="' + size + '" r="' + (size-1) + '" fill="' + color + '" stroke="#fff" stroke-width="1.5"/></svg>'),
        new kakao.maps.Size(size*2, size*2),
        { offset: new kakao.maps.Point(size, size) }
    );
    return new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        image: img
    });
}

function createMarker(lat, lng, color, type) {
    var size = 10;
    var svg;

    if (type === 'rail') {
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><text x="10" y="15" font-size="14" text-anchor="middle">ğŸš‚</text></svg>');
        size = 20;
    } else if (type === 'highway') {
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><text x="10" y="15" font-size="14" text-anchor="middle">ğŸ›£ï¸</text></svg>');
        size = 20;
    } else if (type === 'dev') {
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><text x="10" y="15" font-size="14" text-anchor="middle">ğŸ—ï¸</text></svg>');
        size = 20;
    } else if (type === 'inside') {
        // ì§€êµ¬ë‚´ - í° ë¹¨ê°„ ë§ˆì»¤ (ê°•ì¡°)
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="' + color + '" stroke="white" stroke-width="2"/><text x="12" y="16" font-size="10" font-weight="bold" fill="white" text-anchor="middle" font-family="sans-serif">â˜…</text></svg>');
        size = 24;
    } else if (type === 'inside_polygon') {
        // ì§€êµ¬ë‚´(í´ë¦¬ê³¤) - ì£¼í™©ìƒ‰ ì›
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="9" cy="9" r="7" fill="' + color + '" stroke="white" stroke-width="2"/></svg>');
        size = 18;
    } else if (type === 'auction') {
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"><circle cx="7" cy="7" r="6" fill="' + color + '" stroke="white" stroke-width="1"/><text x="7" y="11" font-size="8" font-weight="bold" fill="white" text-anchor="middle" font-family="sans-serif">ê²½</text></svg>');
        size = 14;
    } else if (type === 'public') {
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"><circle cx="7" cy="7" r="6" fill="' + color + '" stroke="white" stroke-width="1"/><text x="7" y="11" font-size="8" font-weight="bold" fill="white" text-anchor="middle" font-family="sans-serif">ê³µ</text></svg>');
        size = 14;
    } else {
        svg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="4" fill="' + color + '" stroke="white" stroke-width="1"/></svg>');
        size = 10;
    }

    var img = new kakao.maps.MarkerImage(svg, new kakao.maps.Size(size, size), {offset: new kakao.maps.Point(size/2, size/2)});
    return new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        image: img
    });
}

function createAuctionInfo(d, type) {
    var typeColor = type === 'ê³µë§¤' ? '#a855f7' : type === 'ì§€êµ¬ë‚´' ? '#ef4444' : type === 'ì§€êµ¬ì¸ê·¼' ? '#f97316' : '#6366f1';
    var projectInfo = d.project ? '<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;border-left:3px solid #ef4444;font-size:11px;color:#fca5a5">ğŸ“ ' + d.project + '</div>' : '';
    return '<div style="padding:16px 20px;max-width:320px;font-size:12px;line-height:1.7;background:#1a1a1f;color:#e5e5e5;border-radius:12px;border:1px solid rgba(255,255,255,0.1);font-family:Pretendard,sans-serif">' +
        '<div style="font-size:14px;font-weight:600;color:#fff;margin-bottom:8px">' + d.case_no + '</div>' +
        '<div style="color:rgba(255,255,255,0.5);font-size:11px;margin-bottom:12px">' + d.address + '</div>' +
        projectInfo +
        '<div style="display:grid;gap:6px;margin-top:10px">' +
        '<div style="display:flex;justify-content:space-between"><span style="color:rgba(255,255,255,0.5)">ìš©ë„</span><span>' + (d.usage || '') + '</span></div>' +
        '<div style="display:flex;justify-content:space-between"><span style="color:rgba(255,255,255,0.5)">ê°ì •ê°€</span><span style="color:#6366f1;font-weight:600">' + formatPrice(d.appraisal) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between"><span style="color:rgba(255,255,255,0.5)">ìµœì €ê°€</span><span style="color:#a855f7;font-weight:600">' + formatPrice(d.min_price) + ' <span style="color:rgba(255,255,255,0.4);font-weight:400">(' + (d.ratio || '') + ')</span></span></div>' +
        '</div>' +
        '<div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center">' +
        '<span style="color:rgba(255,255,255,0.4);font-size:11px">' + (d.status || '') + ' | ' + (d.date || '') + '</span>' +
        '<span style="background:' + typeColor + ';color:#fff;padding:3px 10px;border-radius:6px;font-size:10px;font-weight:500">' + type + '</span></div></div>';
}

function formatPrice(p) {
    if (!p) return '-';
    if (p >= 100000000) return (p / 100000000).toFixed(1) + 'ì–µ';
    return Math.round(p / 10000).toLocaleString() + 'ë§Œì›';
}

function addClickEvent(marker, infoContent, data) {
    var infowindow = new kakao.maps.InfoWindow({ content: infoContent, removable: true });
    kakao.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map, marker);
        if (data && data.lat && data.lng) {
            // ì§€ë„ ì´ë™ ë° ì¤Œ
            map.setCenter(new kakao.maps.LatLng(data.lat, data.lng));
            if (map.getLevel() > 2) map.setLevel(2);
            // ì§€ì í¸ì§‘ë„ ë ˆì´ì–´ ì¼œê¸°
            map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
            // VWorld APIë¡œ ì‹¤ì œ í•„ì§€ ëª¨ì–‘ ê°€ì ¸ì˜¤ê¸°
            fetchParcelPolygon(data.lat, data.lng, data.address || '');
        }
    });
}

function showParcel(lat, lng, address, areaInfo) {
    if (curPoly) { curPoly.setMap(null); curPoly = null; }
    map.setCenter(new kakao.maps.LatLng(lat, lng));
    if (map.getLevel() > 2) map.setLevel(2);

    // ë©´ì  ì •ë³´ì—ì„œ í† ì§€ ë©´ì  ì¶”ì¶œ (ì˜ˆ: "ê±´ë¬¼ 2,290.82ã¡, í† ì§€ 3,451ã¡")
    var landArea = 100; // ê¸°ë³¸ê°’ 100ã¡
    if (areaInfo) {
        var match = areaInfo.match(/í† ì§€\s*([\d,]+(?:\.\d+)?)\s*ã¡/);
        if (match) {
            landArea = parseFloat(match[1].replace(/,/g, ''));
        } else {
            // ëŒ€ì§€ê¶Œ í˜•íƒœ (ì˜ˆ: "ëŒ€ì§€ê¶Œ 41.7ã¡")
            match = areaInfo.match(/ëŒ€ì§€ê¶Œ?\s*([\d,]+(?:\.\d+)?)\s*ã¡/);
            if (match) {
                landArea = parseFloat(match[1].replace(/,/g, ''));
            }
        }
    }

    console.log('í•„ì§€ í‘œì‹œ:', lat, lng, 'ë©´ì :', landArea, 'ã¡');

    // ë©´ì ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ë³€ì˜ ê¸¸ì´ ê³„ì‚° (ì •ì‚¬ê°í˜• ê°€ì •)
    var side = Math.sqrt(landArea); // ë¯¸í„° ë‹¨ìœ„

    // ìœ„ë„/ê²½ë„ ë³€í™˜ (1ë„ â‰ˆ 111km)
    var latOffset = (side / 2) / 111000;
    var lngOffset = (side / 2) / (111000 * Math.cos(lat * Math.PI / 180));

    // ì‚¬ê°í˜• í´ë¦¬ê³¤ ìƒì„±
    var path = [
        new kakao.maps.LatLng(lat - latOffset, lng - lngOffset),
        new kakao.maps.LatLng(lat - latOffset, lng + lngOffset),
        new kakao.maps.LatLng(lat + latOffset, lng + lngOffset),
        new kakao.maps.LatLng(lat + latOffset, lng - lngOffset)
    ];

    curPoly = new kakao.maps.Polygon({
        path: path,
        strokeWeight: 3,
        strokeColor: '#ef4444',
        strokeOpacity: 1,
        strokeStyle: 'solid',
        fillColor: '#ef4444',
        fillOpacity: 0.35,
        map: map
    });

    // í•„ì§€ ì •ë³´ íŒ¨ë„ í‘œì‹œ
    document.getElementById('parcel-jibun').textContent = '-';
    document.getElementById('parcel-area').textContent = landArea.toLocaleString() + 'ã¡';
    document.getElementById('parcel-addr').textContent = address ? address.substring(0, 25) + '...' : '-';
    document.getElementById('parcel-info').classList.add('active');
}

function toggleLayer(category) {
    var chk = document.getElementById('layer-' + category);
    var show = chk.checked;

    // 500m í•„í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í•„í„° ì¬ì ìš©
    if (filter500mEnabled && ['exact_match', 'need_check', 'nearby_500m', 'nearby_1km', 'general_auction', 'general_public'].indexOf(category) >= 0) {
        toggle500mFilter();
        return;
    }

    // ê²½ë§¤/ê³µë§¤ëŠ” lazy loading
    if (category === 'general_auction' && show && !generalAuctionLoaded) {
        loadAuctionData(function() {
            clusterers.general_auction.setMap(map);
        });
        return;
    }
    if (category === 'general_public' && show && !generalPublicLoaded) {
        loadPublicData(function() {
            clusterers.general_public.setMap(map);
        });
        return;
    }

    // í´ëŸ¬ìŠ¤í„°ëŸ¬ê°€ ìˆëŠ” ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
    if (clusterers[category]) {
        clusterers[category].setMap(show ? map : null);
    } else {
        markers[category].forEach(function(m) {
            m.setMap(show ? map : null);
        });
    }
}

function setMapType(type) {
    var mapTypes = {
        'roadmap': kakao.maps.MapTypeId.ROADMAP,
        'skyview': kakao.maps.MapTypeId.SKYVIEW
    };
    map.setMapTypeId(mapTypes[type]);
    document.querySelectorAll('.map-type-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

var cadastralOn = false;
function toggleCadastral() {
    cadastralOn = !cadastralOn;
    if (cadastralOn) {
        map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
    } else {
        map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
    }
    event.target.classList.toggle('active', cadastralOn);
}

function zoomIn() { map.setLevel(map.getLevel() - 1); }
function zoomOut() { map.setLevel(map.getLevel() + 1); }

// ë¡œë“œë·° ê´€ë ¨ ë³€ìˆ˜
var roadview = null;
var roadviewClient = null;
var roadviewModeEnabled = false;
var roadviewClickListener = null;

// ë¡œë“œë·° ëª¨ë“œ í† ê¸€
function toggleRoadviewMode() {
    roadviewModeEnabled = !roadviewModeEnabled;
    var btns = document.querySelectorAll('.map-type-btn');

    if (roadviewModeEnabled) {
        // ë¡œë“œë·° ëª¨ë“œ í™œì„±í™”
        btns[2].classList.add('active');
        btns[0].classList.remove('active');
        btns[1].classList.remove('active');

        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        roadviewClickListener = kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            var latlng = mouseEvent.latLng;
            showRoadview(latlng.getLat(), latlng.getLng());
        });

        alert('ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ì˜ ë¡œë“œë·°ê°€ í‘œì‹œë©ë‹ˆë‹¤.');
    } else {
        // ë¡œë“œë·° ëª¨ë“œ ë¹„í™œì„±í™”
        btns[2].classList.remove('active');
        btns[0].classList.add('active');

        if (roadviewClickListener) {
            kakao.maps.event.removeListener(roadviewClickListener);
            roadviewClickListener = null;
        }
    }
}

// ë¡œë“œë·° í‘œì‹œ
function showRoadview(lat, lng) {
    var position = new kakao.maps.LatLng(lat, lng);

    // ê°€ì¥ ê°€ê¹Œìš´ ë¡œë“œë·° ìœ„ì¹˜ ì°¾ê¸°
    roadviewClient.getNearestPanoId(position, 50, function(panoId) {
        if (panoId === null) {
            alert('ì´ ìœ„ì¹˜ì—ëŠ” ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¡œë“œë·° ì»¨í…Œì´ë„ˆ í‘œì‹œ
        document.getElementById('roadview').classList.add('active');
        document.querySelector('.roadview-close').classList.add('active');

        // ë¡œë“œë·° ì´ë™
        roadview.setPanoId(panoId, position);
    });
}

// ë¡œë“œë·° ë‹«ê¸°
function closeRoadview() {
    document.getElementById('roadview').classList.remove('active');
    document.querySelector('.roadview-close').classList.remove('active');
}

// ë¡œë“œë·° ì´ˆê¸°í™” (init í•¨ìˆ˜ ëì—ì„œ í˜¸ì¶œ)

// ====== ê²€ìƒ‰ ê¸°ëŠ¥ ======
var allSearchableItems = [];

function initSearchData() {
    // ì‚¬ì—…ì˜ˆì •ì§€ ë°ì´í„° ìˆ˜ì§‘
    DATA_rail.forEach(function(d) {
        allSearchableItems.push({
            type: 'rail', name: d.station || d.name || '',
            address: d.address || '', lat: d.lat, lng: d.lng,
            category: 'ì² ë„ì˜ˆì •ì§€'
        });
    });
    DATA_highway.forEach(function(d) {
        allSearchableItems.push({
            type: 'highway', name: d.name || '',
            address: d.address || '', lat: d.lat, lng: d.lng,
            category: 'ê³ ì†ë„ë¡œIC'
        });
    });
    DATA_ic.forEach(function(d) {
        allSearchableItems.push({
            type: 'ic', name: d.name || '',
            address: d.address || '', lat: d.lat, lng: d.lng,
            category: 'ICì§„ì¶œì…ë¡œ'
        });
    });
    DATA_dev.forEach(function(d) {
        var lat = d.lat, lng = d.lng;
        if (!lat && d.path && d.path.length > 0) {
            lat = d.path.reduce(function(s,p){return s+p[0];},0) / d.path.length;
            lng = d.path.reduce(function(s,p){return s+p[1];},0) / d.path.length;
        }
        if (lat && lng) {
            allSearchableItems.push({
                type: 'dev', name: d.name || '',
                address: d.address || '', lat: lat, lng: lng,
                category: 'ê°œë°œì˜ˆì •ì§€'
            });
        }
    });
    console.log('ê²€ìƒ‰ ë°ì´í„°:', allSearchableItems.length, 'ê°œ');
}

function handleSearchKeyup(e) {
    if (e.key === 'Enter') performSearch();
}

function performSearch() {
    var query = document.getElementById('search-input').value.trim().toLowerCase();
    var resultsDiv = document.getElementById('search-results');

    if (query.length < 2) {
        resultsDiv.classList.remove('active');
        return;
    }

    var results = allSearchableItems.filter(function(item) {
        return (item.name && item.name.toLowerCase().includes(query)) ||
               (item.address && item.address.toLowerCase().includes(query));
    }).slice(0, 10);

    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item"><div class="search-result-name">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
    } else {
        resultsDiv.innerHTML = results.map(function(r) {
            return '<div class="search-result-item" onclick="goToLocation(' + r.lat + ',' + r.lng + ',\'' +
                   r.name.replace(/'/g, "\\'") + '\')">' +
                   '<div class="search-result-name"><span class="search-result-cat">' + r.category + '</span>' +
                   r.name + '</div>' +
                   '<div class="search-result-addr">' + (r.address || '') + '</div></div>';
        }).join('');
    }
    resultsDiv.classList.add('active');
}

function goToLocation(lat, lng, name) {
    map.setCenter(new kakao.maps.LatLng(lat, lng));
    map.setLevel(3);
    document.getElementById('search-results').classList.remove('active');
    document.getElementById('search-input').value = name;
}

// ê²€ìƒ‰ ê²°ê³¼ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    var panel = document.querySelector('.search-panel');
    if (panel && !panel.contains(e.target)) {
        document.getElementById('search-results').classList.remove('active');
    }
});

// ====== ê°€ê²© í•„í„° ======
var currentPriceFilter = 'all';
var auctionDataByMarker = new Map();

function applyPriceFilter() {
    var selected = document.querySelector('input[name="price"]:checked').value;
    currentPriceFilter = selected;

    var categories = ['exact_match', 'need_check', 'nearby_500m', 'nearby_1km', 'general_auction', 'general_public'];
    var count = 0;

    categories.forEach(function(cat) {
        var layerChk = document.getElementById('layer-' + cat);
        if (!layerChk) return;

        markers[cat].forEach(function(m, idx) {
            var data = auctionDataByMarker.get(m);
            if (!data) return;

            var price = data.min_price || 0;
            var show = false;

            if (selected === 'all') {
                show = true;
            } else if (selected === '1' && price > 0 && price <= 100000000) {
                show = true;
            } else if (selected === '5' && price > 100000000 && price <= 500000000) {
                show = true;
            } else if (selected === '10' && price > 500000000 && price <= 1000000000) {
                show = true;
            } else if (selected === 'over' && price > 1000000000) {
                show = true;
            }

            if (show && layerChk.checked) {
                m.setMap(map);
                count++;
            } else {
                m.setMap(null);
            }
        });
    });

    console.log('ê°€ê²© í•„í„° ì ìš©:', selected, 'í‘œì‹œ:', count);
}

// ====== ê´€ì‹¬ ëª©ë¡ ======
var favorites = [];

function loadFavorites() {
    try {
        var saved = localStorage.getItem('investment-map-favorites');
        if (saved) favorites = JSON.parse(saved);
    } catch(e) {}
    updateFavoritesUI();
}

function saveFavorites() {
    try {
        localStorage.setItem('investment-map-favorites', JSON.stringify(favorites));
    } catch(e) {}
}

function toggleFavorites() {
    var panel = document.getElementById('favorites-panel');
    panel.classList.toggle('active');
}

function addToFavorites(name, address, lat, lng, category) {
    // ì¤‘ë³µ ì²´í¬
    var exists = favorites.some(function(f) {
        return f.lat === lat && f.lng === lng;
    });
    if (exists) {
        alert('ì´ë¯¸ ê´€ì‹¬ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    favorites.push({ name: name, address: address, lat: lat, lng: lng, category: category });
    saveFavorites();
    updateFavoritesUI();
    alert('ê´€ì‹¬ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function removeFromFavorites(index) {
    favorites.splice(index, 1);
    saveFavorites();
    updateFavoritesUI();
}

function updateFavoritesUI() {
    var countEl = document.getElementById('favorites-count');
    var listEl = document.getElementById('favorites-list');

    countEl.textContent = favorites.length;

    if (favorites.length === 0) {
        listEl.innerHTML = '<div class="favorites-empty">ê´€ì‹¬ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
    } else {
        listEl.innerHTML = favorites.map(function(f, i) {
            return '<div class="favorite-item" onclick="goToLocation(' + f.lat + ',' + f.lng + ',\'' +
                   f.name.replace(/'/g, "\\'") + '\')">' +
                   '<div class="favorite-info">' +
                   '<div class="favorite-name">' + f.name + '</div>' +
                   '<div class="favorite-addr">' + (f.address || f.category || '') + '</div>' +
                   '</div>' +
                   '<button class="favorite-remove" onclick="event.stopPropagation();removeFromFavorites(' + i + ')">âœ•</button>' +
                   '</div>';
        }).join('');
    }
}

function goToFavorite(lat, lng) {
    map.setCenter(new kakao.maps.LatLng(lat, lng));
    map.setLevel(3);
}


// ====== í•„ì§€ í´ë¦¬ê³¤ í‘œì‹œ ======
var VWORLD_KEY = 'E5B1657B-9B6F-3A4B-91EF-98512BE931A1';
var currentParcelPolygon = null;

// í•„ì§€ í´ë¦¬ê³¤ ê°€ì ¸ì˜¤ê¸°
function fetchParcelPolygon(lat, lng, address) {
    // ê¸°ì¡´ í´ë¦¬ê³¤ ì œê±°
    if (currentParcelPolygon) {
        currentParcelPolygon.setMap(null);
        currentParcelPolygon = null;
    }

    // ì „ì—­ ì½œë°± í•¨ìˆ˜ ì´ë¦„ ìƒì„±
    var callbackName = 'vworldCallback_' + Date.now();
    
    // Vworld WFS JSONP ìš”ì²­
    var url = 'https://api.vworld.kr/req/wfs?SERVICE=WFS&REQUEST=GetFeature' +
              '&TYPENAME=lp_pa_cbnd_bubun' +
              '&BBOX=' + (lng - 0.001) + ',' + (lat - 0.001) + ',' + (lng + 0.001) + ',' + (lat + 0.001) +
              '&SRSNAME=EPSG:4326' +
              '&OUTPUT=text/javascript' +
              '&format_options=callback:' + callbackName +
              '&KEY=' + VWORLD_KEY;

    console.log('í•„ì§€ ì¡°íšŒ (JSONP):', lat, lng);

    // ì½œë°± í•¨ìˆ˜ ë“±ë¡
    window[callbackName] = function(data) {
        console.log('Vworld ì‘ë‹µ:', data);
        // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì œê±°
        var script = document.getElementById(callbackName);
        if (script) script.remove();
        delete window[callbackName];

        if (data.features && data.features.length > 0) {
            var closest = null;
            var minDist = Infinity;

            data.features.forEach(function(feature) {
                var coords = feature.geometry.coordinates[0];
                if (feature.geometry.type === 'MultiPolygon') {
                    coords = feature.geometry.coordinates[0][0];
                }
                var cx = coords.reduce(function(s, c) { return s + c[0]; }, 0) / coords.length;
                var cy = coords.reduce(function(s, c) { return s + c[1]; }, 0) / coords.length;
                var dist = Math.sqrt(Math.pow(cx - lng, 2) + Math.pow(cy - lat, 2));
                if (dist < minDist) {
                    minDist = dist;
                    closest = feature;
                }
            });

            if (closest) {
                drawParcelPolygon(closest, address);
            }
        } else {
            console.log('í•„ì§€ ë°ì´í„° ì—†ìŒ');
            showParcel(lat, lng, address, '');
        }
    };

    // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ë¡œ JSONP ìš”ì²­
    var script = document.createElement('script');
    script.id = callbackName;
    script.src = url;
    script.onerror = function() {
        console.error('í•„ì§€ ì¡°íšŒ ì‹¤íŒ¨');
        delete window[callbackName];
        script.remove();
        showParcel(lat, lng, address, '');
    };
    document.body.appendChild(script);
}

// ì£¼ì†Œ ê¸°ë°˜ í•„ì§€ ì¡°íšŒ (ëŒ€ì²´)
function fetchParcelByAddress(lat, lng, address) {
    // ê°„ë‹¨í•œ ì›í˜•ìœ¼ë¡œ í‘œì‹œ
    drawCircleMarker(lat, lng);
}

// í•„ì§€ í´ë¦¬ê³¤ ê·¸ë¦¬ê¸°
function drawParcelPolygon(feature, address) {
    var coords = feature.geometry.coordinates[0];
    if (feature.geometry.type === 'MultiPolygon') {
        coords = feature.geometry.coordinates[0][0];
    }

    var path = coords.map(function(c) {
        return new kakao.maps.LatLng(c[1], c[0]);
    });

    currentParcelPolygon = new kakao.maps.Polygon({
        path: path,
        strokeWeight: 3,
        strokeColor: '#ef4444',
        strokeOpacity: 1,
        strokeStyle: 'solid',
        fillColor: '#ef4444',
        fillOpacity: 0.35
    });
    currentParcelPolygon.setMap(map);

    // í•„ì§€ ì •ë³´ í‘œì‹œ
    var props = feature.properties || {};
    document.getElementById('parcel-jibun').textContent = props.jibun || props.lndcgr_nm || '-';
    document.getElementById('parcel-area').textContent = props.area ? (parseFloat(props.area).toLocaleString() + 'ã¡') : '-';
    document.getElementById('parcel-addr').textContent = address ? address.substring(0, 30) : '-';
    document.getElementById('parcel-info').classList.add('active');

    // í´ë¦¬ê³¤ ì˜ì—­ìœ¼ë¡œ ì§€ë„ ì´ë™
    var bounds = new kakao.maps.LatLngBounds();
    path.forEach(function(p) { bounds.extend(p); });
    map.setBounds(bounds, 50);
}

// ì›í˜• ë§ˆì»¤ (í´ë¦¬ê³¤ ì—†ì„ ë•Œ)
function drawCircleMarker(lat, lng) {
    if (currentParcelPolygon) {
        currentParcelPolygon.setMap(null);
    }

    currentParcelPolygon = new kakao.maps.Circle({
        center: new kakao.maps.LatLng(lat, lng),
        radius: 30,
        strokeWeight: 3,
        strokeColor: '#ef4444',
        strokeOpacity: 1,
        fillColor: '#ef4444',
        fillOpacity: 0.3
    });
    currentParcelPolygon.setMap(map);
}

// í•„ì§€ ì •ë³´ íŒ¨ë„ ë‹«ê¸°
function closeParcelInfo() {
    document.getElementById('parcel-info').classList.remove('active');
    if (currentParcelPolygon) {
        currentParcelPolygon.setMap(null);
        currentParcelPolygon = null;
    }
}

function initRoadview() {
    var rvContainer = document.getElementById('roadview');
    roadview = new kakao.maps.Roadview(rvContainer);
    roadviewClient = new kakao.maps.RoadviewClient();
}
</script>
<script>
(function() {
    var s = document.createElement('script');
    s.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=7e60f6a42602355b925c66ea6db3bd87&libraries=services,clusterer&autoload=false';
    s.onload = function() {
        kakao.maps.load(function() {
            init();
            initRoadview();
            initSearchData();
            loadFavorites();
        });
    };
    document.head.appendChild(s);
})();
</script>
</body>
</html>